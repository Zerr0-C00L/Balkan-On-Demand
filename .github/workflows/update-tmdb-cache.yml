name: Update TMDB Cache

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-tmdb-cache:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Clear TMDB cache
        run: |
          echo "üßπ Clearing TMDB cache to fetch fresh metadata..."
          # TMDB cache is in-memory, so restarting will clear it
          # This workflow just documents the cache refresh strategy
          echo "‚úÖ Cache will be refreshed on next server restart"
      
      - name: Verify stream database
        run: |
          echo "üîç Verifying stream database integrity..."
          
          # Check if database exists and is valid JSON
          if [ -f "data/baubau-content.json" ]; then
            MOVIES=$(jq '.stats.totalMovies' data/baubau-content.json)
            SERIES=$(jq '.stats.totalSeries' data/baubau-content.json)
            
            echo "‚úÖ Stream database valid:"
            echo "   ‚Ä¢ Movies: $MOVIES"
            echo "   ‚Ä¢ Series: $SERIES"
          else
            echo "‚ùå Stream database not found!"
            exit 1
          fi
      
      - name: Test TMDB API (if key configured)
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        run: |
          if [ -n "$TMDB_API_KEY" ]; then
            echo "üîë Testing TMDB API connection..."
            
            RESPONSE=$(curl -s "https://api.themoviedb.org/3/configuration?api_key=$TMDB_API_KEY")
            
            if echo "$RESPONSE" | jq -e '.images' > /dev/null 2>&1; then
              echo "‚úÖ TMDB API key is valid"
            else
              echo "‚ùå TMDB API key is invalid or expired"
              echo "$RESPONSE"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  TMDB_API_KEY not configured in secrets"
            echo "   Add it at: Settings ‚Üí Secrets ‚Üí Actions"
          fi
      
      - name: Check Heroku deployment
        run: |
          echo "üöÄ Verifying Heroku deployment status..."
          echo "   If Heroku is connected to GitHub, it will auto-deploy"
          echo "   v5 addon: Running on port 7005"
          echo "   v6 addon: Running on port 7006 (requires TMDB_API_KEY)"
      
      - name: Summary
        run: |
          echo "‚úÖ TMDB cache refresh complete!"
          echo ""
          echo "üìä Next Steps:"
          echo "   1. Heroku will auto-restart with fresh TMDB cache"
          echo "   2. New TMDB metadata will be fetched on demand"
          echo "   3. Stream matching will use latest database"
